
PERL=/usr/bin/perl
PERLSRCDIR=`$(PERL) -MConfig -e 'print $$Config{archlib}'`/CORE
CXX=g++
CC=gcc
AR=ar
RANLIB=ranlib
CFLAGS=
LDFLAGS=

all: embedperl.a

# because you can't add .a's into .a's, embedperl first copies libperl.a
embedperl.a: DaZeus2.o embedperl.o xsinit.o main.o
	cp "$(PERLSRCDIR)"/libperl.a embedperl.a
	chmod 0644 embedperl.a
	ar x "$(PERLSRCDIR)"/../auto/DynaLoader/DynaLoader.a
	$(AR) cur embedperl.a main.o DaZeus2.o embedperl.o xsinit.o DynaLoader.o
	$(RANLIB) -c embedperl.a

main.o: main.cpp
	$(CXX) $(CFLAGS) -c -o main.o main.cpp -I "$(PERLSRCDIR)"

DaZeus2.c: DaZeus2.xs
	xsubpp DaZeus2.xs >DaZeus2.c

DaZeus2.o: DaZeus2.c
	$(CC) $(CFLAGS) -c -o DaZeus2.o -I $(PERLSRCDIR) DaZeus2.c

embedperl.o: embedperl.cpp
	$(CXX) $(CFLAGS) -c -o embedperl.o embedperl.cpp -I $(PERLSRCDIR) -Dbool=char -DHAS_BOOL

xsinit.c:
	$(PERL) -MExtUtils::Embed -e xsinit -- -o xsinit.c -std DaZeus2

xsinit.o: xsinit.c
	$(CC) $(CFLAGS) -c xsinit.c `$(PERL) -MExtUtils::Embed -e ccopts`

clean:
	rm -f test DaZeus2.c DaZeus2.o embedperl.o xsinit.c xsinit.o

