PERL=/usr/bin/perl

PERLINCDIR=`$(PERL) -MConfig -e 'print $$Config{archlib}'`/CORE
# On some systems:
#PERLLIBDIR=$(PERLINCDIR)
# On most systems:
PERLLIBDIR=/usr/lib

CXX=g++
CC=gcc
AR=ar
RANLIB=ranlib
CFLAGS=-DINSIDE_PERLEMBED
LDFLAGS=

DYNA_LINK_HINTS=${$(PERL) -MExtUtils::Embed -e '$_=ldopts(true);print if s/^.*\s(\S*DynaLoader.a).*$/$1/';}

all: embedperl.a

# because you can't add .a's into .a's, embedperl first copies libperl.a
embedperl.a: DaZeus2.o embedperl.o xsinit.o DynaLoader.o
	cp "$(PERLLIBDIR)"/libperl.a embedperl.a
	chmod 0644 embedperl.a
	$(AR) cur embedperl.a DaZeus2.o embedperl.o xsinit.o
	-[ -n "$(DYNA_LINK_HINTS)" ] && $(AR) cur DynaLoader.o
	$(RANLIB) embedperl.a

DynaLoader.o:
	-[ -n "$(DYNA_LINK_HINTS)" ] && ar x $(DYNA_LINK_HINTS)
	touch DynaLoader.o # create if nonexistant

DaZeus2.c: DaZeus2.xs
	xsubpp DaZeus2.xs >DaZeus2.c

DaZeus2.o: DaZeus2.c
	$(CC) $(CFLAGS) -c -o DaZeus2.o -I $(PERLINCDIR) DaZeus2.c

embedperl.o: embedperl.cpp
	$(CXX) $(CFLAGS) -c -o embedperl.o embedperl.cpp -I $(PERLINCDIR) -Dbool=char -DHAS_BOOL

xsinit.c:
	$(PERL) -MExtUtils::Embed -e xsinit -- -o xsinit.c -std DaZeus2

xsinit.o: xsinit.c
	$(CC) $(CFLAGS) -c xsinit.c `$(PERL) -MExtUtils::Embed -e ccopts`

clean:
	rm -f DaZeus2.c DaZeus2.o embedperl.o xsinit.c xsinit.o

