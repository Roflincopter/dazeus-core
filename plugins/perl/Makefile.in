PERL=/usr/bin/perl

PERLINCDIR=`$(PERL) -MConfig -e 'print $$Config{archlib}'`/CORE
# On some systems:
#PERLLIBDIR=$(PERLINCDIR)
# On most systems:
PERLLIBDIR=/usr/lib

CXX=g++
CC=gcc
AR=ar
RANLIB=ranlib
CFLAGS=-DINSIDE_PERLEMBED
LDFLAGS=

DYNA_LINK_HINTS := $(shell $(PERL) -MExtUtils::Embed -e '$$_=ldopts(true);print if s/^.*\s(\S*DynaLoader.a).*$$/$$1/';)

all: embedperl.a

# Copy either libperl.a, libperl.so or libperl.dylib here
perllib:
	-[ -f "$(PERLLIBDIR)/libperl.so" ] && cp $(PERLLIBDIR)/libperl.so .
	-[ -f "$(PERLLIBDIR)/libperl.dylib" ] && cp $(PERLLIBDIR)/libperl.dylib .
	-[ -f "$(PERLLIBDIR)/libperl.a" ] && cp $(PERLLIBDIR)/libperl.a
	touch perllib

embedperl.a: perllib DaZeus2.o embedperl.o xsinit.o DynaLoader.o
	rm -f embedperl.a
	$(AR) cur embedperl.a DaZeus2.o embedperl.o xsinit.o
	-[ -n "$(DYNA_LINK_HINTS)" ] && $(AR) cur embedperl.a DynaLoader.o
	$(RANLIB) embedperl.a

DynaLoader.o:
	-[ -n "$(DYNA_LINK_HINTS)" ] && ar x $(DYNA_LINK_HINTS)
	touch DynaLoader.o # create if nonexistant

DaZeus2.c: DaZeus2.xs
	xsubpp DaZeus2.xs >DaZeus2.c

DaZeus2.o: DaZeus2.c
	$(CC) $(CFLAGS) -c -o DaZeus2.o -I $(PERLINCDIR) DaZeus2.c

embedperl.o: embedperl.cpp
	$(CXX) $(CFLAGS) -c -o embedperl.o embedperl.cpp -I $(PERLINCDIR) -Dbool=char -DHAS_BOOL

xsinit.c:
	$(PERL) -MExtUtils::Embed -e xsinit -- -o xsinit.c -std DaZeus2

xsinit.o: xsinit.c
	$(CC) $(CFLAGS) -c xsinit.c `$(PERL) -MExtUtils::Embed -e ccopts`

clean:
	rm -f DaZeus2.c DaZeus2.o embedperl.o xsinit.c xsinit.o __.SYMDEF\ SORTED
	rm -f libperl.a libperl.so libperl.dylib embedperl.a perllib

